<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilm ðŸ’œ - Account</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0a0a0a" />

  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icon.png" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/bilm/shared/theme.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      padding: 30px 20px 120px;
    }

    .auth-container {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .page-header h1 {
      font-size: clamp(2rem, 3vw, 2.8rem);
    }

    .page-header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
      display: grid;
      gap: 16px;
    }

    .card h2 {
      font-size: 1.2rem;
    }

    .card p {
      color: var(--text-muted);
      line-height: 1.5;
      font-size: 0.95rem;
    }

    .form-grid {
      display: grid;
      gap: 14px;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="url"],
    textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-family: inherit;
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      box-shadow: 0 10px 20px rgba(124, 58, 237, 0.35);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(124, 58, 237, 0.45);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn-outline:hover {
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .row span {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hint {
      font-size: 0.85rem;
      color: var(--text-subtle);
    }

    .status {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      border: 1px solid transparent;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .status.success {
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
    }

    .status.error {
      border-color: rgba(239, 68, 68, 0.4);
      color: #ef4444;
    }

    .split {
      display: grid;
      gap: 20px;
    }

    @media (min-width: 860px) {
      .split {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>

  <script src="/bilm/shared/access.js"></script>
  <script src="/bilm/shared/theme.js"></script>
  <script src="/bilm/shared/supabase-config.js"></script>
  <script src="/bilm/shared/auth.js"></script>
</head>
<body>
  <div id="navbarContainer"></div>

  <main>
    <div class="auth-container">
      <div class="page-header">
        <h1>Account</h1>
        <p>Sign in to sync your favorites, watch history, and settings across devices. Login is optional.</p>
      </div>

      <section class="card">
        <h2>Sign In</h2>
        <p>Use Google to sync your favorites, history, and settings across devices.</p>
        <div class="row">
          <button class="btn btn-outline" type="button" id="googleLoginBtn">Continue with Google</button>
        </div>
      </section>

      <section class="card">
        <h2>Account Status</h2>
        <p>Check who is logged in and sync your latest data.</p>
        <div class="status" id="accountStatus">Loading account statusâ€¦</div>
        <div class="row">
          <button class="btn btn-outline" type="button" id="syncBtn">Sync now</button>
          <button class="btn btn-danger" type="button" id="logoutBtn">Log out</button>
        </div>
        <div class="form-grid">
          <div>
            <label for="usernameUpdate">Update username</label>
            <input type="text" id="usernameUpdate" placeholder="New username" />
            <p class="hint">Used for display in the desktop navbar.</p>
          </div>
          <button class="btn btn-outline" type="button" id="updateUsernameBtn">Save Username</button>
        </div>
      </section>

      <section class="card">
        <h2>Supabase Setup</h2>
        <p>To enable login and cloud sync, create a Supabase project and paste your project URL + anon key below.</p>
        <div class="form-grid">
          <div>
            <label for="supabaseUrl">Supabase URL</label>
            <input type="url" id="supabaseUrl" placeholder="https://xxxx.supabase.co" />
          </div>
          <div>
            <label for="supabaseAnonKey">Supabase Anon Key</label>
            <input type="text" id="supabaseAnonKey" placeholder="eyJhbGciOiJIUzI1NiIs..." />
          </div>
          <button class="btn" type="button" id="saveConfigBtn">Save Supabase Config</button>
        </div>
        <p class="hint">Find these values in Supabase â†’ Project Settings â†’ API.</p>
        <h3>SQL setup</h3>
        <p class="hint">Run this in Supabase â†’ SQL Editor to enable profiles + cloud sync.</p>
        <textarea readonly>
create table if not exists profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  email text
);

create table if not exists user_data (
  user_id uuid references auth.users not null primary key,
  data jsonb,
  updated_at timestamptz default now()
);

alter table profiles enable row level security;
alter table user_data enable row level security;

create policy "Profiles are readable by username" on profiles
  for select using (true);

create policy "Users manage their profile" on profiles
  for all using (auth.uid() = id) with check (auth.uid() = id);

create policy "Users manage their data" on user_data
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);
        </textarea>
        <p class="hint">Want to hide emails? Remove the email column or restrict it to auth users only.</p>
      </section>
    </div>
  </main>

  <script src="/bilm/shared/navbar.js" defer></script>

  <script>
    const statusEl = document.getElementById('accountStatus');
    const syncBtn = document.getElementById('syncBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const supabaseUrl = document.getElementById('supabaseUrl');
    const supabaseAnonKey = document.getElementById('supabaseAnonKey');
    const usernameUpdate = document.getElementById('usernameUpdate');
    const updateUsernameBtn = document.getElementById('updateUsernameBtn');

    const setStatus = (message, state = '') => {
      statusEl.textContent = message;
      statusEl.className = `status ${state}`.trim();
    };

    const refreshStatus = async () => {
      const auth = window.bilmAuth;
      if (!auth) return;
      await auth.init();
      const profile = await auth.getProfile();
      if (!profile) {
        setStatus('Not logged in.', '');
        return;
      }
      setStatus(`Logged in as ${profile.username || profile.email}.`, 'success');
      usernameUpdate.value = profile.username || '';
    };

    googleLoginBtn.addEventListener('click', async () => {
      setStatus('Redirecting to Google...');
      const { error } = await window.bilmAuth.signInWithGoogle();
      if (error) setStatus(error.message, 'error');
    });

    syncBtn.addEventListener('click', async () => {
      setStatus('Syncing...');
      const { error } = await window.bilmAuth.syncNow();
      if (error) {
        setStatus(error.message, 'error');
        return;
      }
      setStatus('Synced successfully.', 'success');
    });

    logoutBtn.addEventListener('click', async () => {
      const { error } = await window.bilmAuth.signOut();
      if (error) {
        setStatus(error.message, 'error');
        return;
      }
      setStatus('Logged out.', '');
      refreshStatus();
    });

    updateUsernameBtn.addEventListener('click', async () => {
      const nextUsername = usernameUpdate.value.trim();
      if (!nextUsername) {
        setStatus('Enter a username first.', 'error');
        return;
      }
      const { error } = await window.bilmAuth.updateUsername(nextUsername);
      if (error) {
        setStatus(error.message, 'error');
        return;
      }
      setStatus('Username updated.', 'success');
      refreshStatus();
    });

    saveConfigBtn.addEventListener('click', () => {
      window.bilmAuth.saveConfig({
        url: supabaseUrl.value,
        anonKey: supabaseAnonKey.value
      });
      setStatus('Supabase config saved.', 'success');
    });

    window.addEventListener('DOMContentLoaded', async () => {
      const config = window.bilmAuth.readConfig();
      if (config) {
        supabaseUrl.value = config.url;
        supabaseAnonKey.value = config.anonKey;
      }
      await refreshStatus();
    });
  </script>
</body>
</html>
