<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilm ðŸ’œ - Settings</title>

  <!-- PWA + iOS fullscreen support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0a0a0a" />

  <!-- PWA Manifest and Icon -->
  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icon.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../shared/theme.css" />
    
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100vw;
      min-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
    }

    .settings-content {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 28px 22px 80px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 20px 0 26px;
    }

    .page-header h1 {
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      color: var(--text-primary);
    }

    .page-header p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .settings-card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .settings-card h2 {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .settings-card p {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: var(--surface-2);
      border: 1px solid transparent;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      flex-wrap: wrap;
    }

    .control-row:hover {
      border-color: var(--accent-soft);
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .control-row label {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .control-row > div {
      min-width: 180px;
      flex: 1 1 auto;
    }

    .control-row small {
      display: block;
      color: var(--text-subtle);
      font-size: 0.75rem;
    }

    select,
    input[type="color"],
    input[type="email"],
    input[type="password"] {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      font-family: inherit;
    }

    select:focus,
    input[type="color"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      flex: 0 0 auto;
      margin-left: auto;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle span {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      transition: background var(--transition-fast);
      cursor: pointer;
    }

    .toggle span::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--text-primary);
      transition: transform var(--transition-fast);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
    }

    .toggle input:checked + span {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .toggle input:checked + span::after {
      transform: translateX(20px);
    }

    .preset-control {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
      flex-wrap: nowrap;
      width: 100%;
      max-width: min(100%, 420px);
      margin-left: 0;
    }

    .inline-picker {
      width: clamp(40px, 10vw, 52px);
      height: 36px;
      padding: 3px;
      flex: 0 1 auto;
    }

    .preset-select {
      min-width: 0;
      flex: 1 1 0;
      max-width: 340px;
    }

    .actions-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      box-shadow: 0 10px 20px rgba(124, 58, 237, 0.35);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(124, 58, 237, 0.45);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
      box-shadow: none;
      text-decoration: none;
    }

    .btn-outline:hover {
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }

    .backup-tools {
      display: grid;
      gap: 10px;
      width: 100%;
    }

    .backup-status {
      font-size: 0.8rem;
      color: var(--text-subtle);
      min-height: 1.1em;
    }

    .data-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(5, 5, 15, 0.75);
      backdrop-filter: blur(8px);
    }

    .data-modal.open {
      display: flex;
    }

    .data-modal__panel {
      width: min(860px, 100%);
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    .data-modal__panel h3 {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .data-modal__panel p {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .data-code {
      width: 100%;
      min-height: 230px;
      resize: vertical;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text-primary);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 0.78rem;
      padding: 10px;
      line-height: 1.4;
    }

    @media (max-width: 720px) {
      .settings-content {
        padding: 20px 16px 80px;
      }

      .control-row {
        align-items: flex-start;
      }
    }
  </style>

  <script src="../shared/access.js"></script>
  <script src="../shared/theme.js"></script>
    </head>
<body>

<div id="navbarContainer"></div>

<main>
  <div class="settings-content">
  <div class="page-header">
    <h1>Settings</h1>
    <p>Personalize the Bilm experience with your preferred theme, motion, and playback defaults.</p>
  </div>

  <div class="settings-grid">
    <section class="settings-card">
      <h2>Theme & Accent</h2>
      <p>Fine tune your accent glow and choose your background mode.</p>

      <div class="control-row">
        <div>
          <label for="accentPresetsSelect">Accent Color</label>
          <small>Choose from presets or pick a custom color.</small>
        </div>
        <div class="preset-control">
          <input id="accentPicker" class="inline-picker" type="color" aria-label="Custom accent color" />
          <select id="accentPresetsSelect" class="preset-select" aria-label="Accent color presets"></select>
        </div>
      </div>

      <div class="control-row">
        <div>
          <label for="backgroundSelect">Background Mode</label>
          <small>Pick a preset mode or choose a custom color.</small>
        </div>
        <div class="preset-control">
          <input id="customBackgroundPicker" class="inline-picker" type="color" aria-label="Custom background color" />
          <select id="backgroundSelect" class="preset-select">
            <option value="deep">Deep</option>
            <option value="midnight">Midnight</option>
            <option value="velvet">Velvet</option>
            <option value="aurora">Aurora</option>
            <option value="slate">Slate</option>
            <option value="sunset">Sunset</option>
            <option value="custom">Custom</option>
          </select>
        </div>
      </div>
    </section>

    <section class="settings-card">
      <h2>Motion & Effects</h2>
      <p>Control animation and particle effects for performance and comfort.</p>

      <div class="control-row">
        <div>
          <label>Motion</label>
          <small>Reduce transitions and motion.</small>
        </div>
        <label class="toggle">
          <input id="motionToggle" type="checkbox" />
          <span></span>
        </label>
      </div>

      <div class="control-row">
        <div>
          <label>Particles</label>
          <small>Background particle shimmer on home.</small>
        </div>
        <label class="toggle">
          <input id="particleToggle" type="checkbox" />
          <span></span>
        </label>
      </div>
    </section>


    <section class="settings-card">
      <h2>Account</h2>
      <p>Simple account controls: log in, sign up, log out, and open account sync settings.</p>

      <div class="control-row">
        <div>
          <label>Account Status</label>
          <small id="accountStatusText">Checking account status...</small>
        </div>
        <div class="actions-row">
          <button class="btn" id="openSignInBtn">Log In</button>
          <button class="btn btn-outline" id="openSignUpBtn">Sign Up</button>
          <button class="btn btn-outline" id="logoutBtn" hidden>Log Out</button>
        </div>
      </div>

      <div class="control-row">
        <div>
          <label>Account Settings</label>
          <small>Open sync tools and data merge options.</small>
        </div>
        <div class="actions-row">
          <button class="btn" id="openAccountSettingsBtn">Open Account Settings</button>
        </div>
      </div>

      <span class="backup-status" id="cloudStatus" aria-live="polite"></span>
    </section>

    <section class="settings-card">
      <h2>Playback Defaults</h2>
      <p>Choose the default server for your viewer pages.</p>

      <div class="control-row">
        <div>
          <label for="serverSelect">Default Server</label>
          <small>Used for movies and TV viewers.</small>
        </div>
        <select id="serverSelect">
          <option value="vidsrc">VidSrc</option>
          <option value="godrive">GoDrive Player</option>
          <option value="multiembed">MultiEmbed</option>
        </select>
      </div>
    </section>

    <section class="settings-card">
      <h2>History & Privacy</h2>
      <p>Manage how Bilm saves search and watch history on this device.</p>

      <div class="control-row">
        <div>
          <label>View History</label>
          <small>Open your saved search and watch history.</small>
        </div>
        <a class="btn btn-outline" href="../settings/history">View History</a>
              </div>

      <div class="control-row">
        <div>
          <label>Incognito</label>
          <small>Temporarily pause search and watch history.</small>
        </div>
        <label class="toggle">
          <input id="incognitoToggle" type="checkbox" />
          <span></span>
        </label>
      </div>
    </section>

    <section class="settings-card">
      <h2>Backup & Transfer</h2>
      <p>Export a full backup code of your local Bilm data or import one from another device.</p>

      <div class="control-row">
        <div>
          <label>Data Backup</label>
          <small>Includes local storage, session storage, and site cookies.</small>
        </div>
        <div class="backup-tools">
          <button class="btn" id="exportDataBtn">Export Data</button>
          <button class="btn btn-outline" id="importDataBtn">Import Data</button>
          <input id="importFileInput" type="file" accept="application/json,.json,text/plain" hidden />
          <span class="backup-status" id="backupStatus" aria-live="polite"></span>
        </div>
      </div>
    </section>

    <section class="settings-card">
      <h2>Reset & Maintenance</h2>
      <p>Restore defaults or clear all local data.</p>

      <div class="actions-row">
        <button class="btn btn-outline" id="resetThemeBtn">Reset Theme</button>
        <button class="btn btn-danger" id="resetDataBtn">Reset Data</button>
      </div>
    </section>
  </div>
  </div>
</main>


<div class="data-modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
  <div class="data-modal__panel">
    <h3 id="loginModalTitle">Log In</h3>
    <p>Use your email and password to log in.</p>
    <form id="loginForm" autocomplete="on">
      <div class="backup-tools">
        <input id="loginEmail" name="email" type="email" placeholder="Email" autocomplete="email" />
        <input id="loginPassword" name="password" type="password" placeholder="Password" autocomplete="current-password" />
        <button class="btn btn-outline" id="toggleLoginPasswordBtn" type="button">Show Password</button>
        <span class="backup-status" id="loginStatus" aria-live="polite"></span>
        <small id="loginHelperText">Don&apos;t have an account? Use Create an Account.</small>
      </div>
      <div class="actions-row">
        <button class="btn" id="loginBtn" type="button">Log In</button>
        <button class="btn btn-outline" id="openCreateAccountBtn" type="button">Create an Account</button>
        <button class="btn btn-outline" id="closeLoginModalBtn" type="button">Close</button>
      </div>
    </form>
  </div>
</div>

<div class="data-modal" id="signUpModal" role="dialog" aria-modal="true" aria-labelledby="signUpModalTitle">
  <div class="data-modal__panel">
    <h3 id="signUpModalTitle">Sign Up</h3>
    <p>Create an account with your email and password.</p>
    <form id="signUpForm" autocomplete="on">
      <div class="backup-tools">
        <input id="signUpEmail" name="email" type="email" placeholder="Email" autocomplete="email" />
        <input id="signUpPassword" name="password" type="password" placeholder="Password" autocomplete="new-password" />
        <button class="btn btn-outline" id="toggleSignUpPasswordBtn" type="button">Show Password</button>
        <span class="backup-status" id="signUpStatus" aria-live="polite"></span>
      </div>
      <div class="actions-row">
        <button class="btn" id="signUpBtn" type="button">Create Account</button>
        <button class="btn btn-outline" id="backToLoginBtn" type="button">Back to Log In</button>
        <button class="btn btn-outline" id="closeSignUpModalBtn" type="button">Close</button>
      </div>
    </form>
  </div>
</div>

<div class="data-modal" id="dataModal" role="dialog" aria-modal="true" aria-labelledby="dataModalTitle">
  <div class="data-modal__panel">
    <h3 id="dataModalTitle">Backup Code</h3>
    <p id="dataModalMessage">Copy or download this backup code. Keep it private.</p>
    <textarea id="dataCodeField" class="data-code" spellcheck="false"></textarea>
    <div class="actions-row">
      <button class="btn" id="copyDataBtn">Copy Code</button>
      <button class="btn btn-outline" id="downloadDataBtn">Download JSON</button>
      <button class="btn" id="pasteImportBtn" hidden>Paste from Clipboard</button>
      <button class="btn btn-outline" id="uploadImportBtn" hidden>Upload Save File</button>
      <button class="btn btn-outline" id="applyImportBtn" hidden>Apply Import</button>
      <button class="btn btn-outline" id="closeDataModalBtn">Close</button>
    </div>
  </div>
</div>

<script src="../shared/auth.js" defer></script>
<script src="../shared/navbar.js" defer></script>

<script>
  const accentPresets = [
    { value: '#a855f7', label: 'Purple' },
    { value: '#c084fc', label: 'Lilac' },
    { value: '#7c3aed', label: 'Violet' },
    { value: '#ec4899', label: 'Pink' },
    { value: '#38bdf8', label: 'Sky Blue' }
  ];
  const accentPresetsSelect = document.getElementById('accentPresetsSelect');
  const accentPicker = document.getElementById('accentPicker');
  const backgroundSelect = document.getElementById('backgroundSelect');
  const customBackgroundPicker = document.getElementById('customBackgroundPicker');
  const motionToggle = document.getElementById('motionToggle');
  const particleToggle = document.getElementById('particleToggle');
  const incognitoToggle = document.getElementById('incognitoToggle');
  const serverSelect = document.getElementById('serverSelect');
  const resetThemeBtn = document.getElementById('resetThemeBtn');
  const resetDataBtn = document.getElementById('resetDataBtn');
  const exportDataBtn = document.getElementById('exportDataBtn');
  const importDataBtn = document.getElementById('importDataBtn');
  const importFileInput = document.getElementById('importFileInput');
  const backupStatus = document.getElementById('backupStatus');
  const dataModal = document.getElementById('dataModal');
  const dataModalTitle = document.getElementById('dataModalTitle');
  const dataModalMessage = document.getElementById('dataModalMessage');
  const dataCodeField = document.getElementById('dataCodeField');
  const copyDataBtn = document.getElementById('copyDataBtn');
  const downloadDataBtn = document.getElementById('downloadDataBtn');
  const pasteImportBtn = document.getElementById('pasteImportBtn');
  const uploadImportBtn = document.getElementById('uploadImportBtn');
  const applyImportBtn = document.getElementById('applyImportBtn');
  const closeDataModalBtn = document.getElementById('closeDataModalBtn');
  const accountStatusText = document.getElementById('accountStatusText');
  const openSignInBtn = document.getElementById('openSignInBtn');
  const openSignUpBtn = document.getElementById('openSignUpBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const openAccountSettingsBtn = document.getElementById('openAccountSettingsBtn');
  const cloudStatus = document.getElementById('cloudStatus');
  const loginModal = document.getElementById('loginModal');
  const loginForm = document.getElementById('loginForm');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginStatus = document.getElementById('loginStatus');
  const loginHelperText = document.getElementById('loginHelperText');
  const loginBtn = document.getElementById('loginBtn');
  const toggleLoginPasswordBtn = document.getElementById('toggleLoginPasswordBtn');
  const openCreateAccountBtn = document.getElementById('openCreateAccountBtn');
  const closeLoginModalBtn = document.getElementById('closeLoginModalBtn');
  const signUpModal = document.getElementById('signUpModal');
  const signUpForm = document.getElementById('signUpForm');
  const signUpEmail = document.getElementById('signUpEmail');
  const signUpPassword = document.getElementById('signUpPassword');
  const signUpStatus = document.getElementById('signUpStatus');
  const signUpBtn = document.getElementById('signUpBtn');
  const toggleSignUpPasswordBtn = document.getElementById('toggleSignUpPasswordBtn');
  const backToLoginBtn = document.getElementById('backToLoginBtn');
  const closeSignUpModalBtn = document.getElementById('closeSignUpModalBtn');
  const supportedServers = ['vidsrc', 'godrive', 'multiembed'];
  const BACKUP_FORMAT_PREFIX = 'BLM1';
  const BASE62_ALPHABET = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
  let pendingImportPayload = null;
  let autoSaveIntervalId = null;
  let autoSaveTickId = null;
  let nextAutoSaveAt = 0;

  function getGlobalAutoSaveNextAt() {
    const apiNext = window.bilmAuth?.getAutoSaveNextAt?.();
    return Number.isFinite(apiNext) && apiNext > 0 ? apiNext : (nextAutoSaveAt || (Date.now() + 60000));
  }

  function readStorage(storage) {
    return Object.entries(storage).reduce((all, [key, value]) => {
      all[key] = value;
      return all;
    }, {});
  }

  function collectBackupData() {
    return {
      schema: 'bilm-backup-v1',
      exportedAt: new Date().toISOString(),
      origin: location.origin,
      pathname: location.pathname,
      localStorage: readStorage(localStorage),
      sessionStorage: readStorage(sessionStorage),
      cookies: document.cookie
    };
  }

  function hashSeed(input) {
    let hash = 2166136261;
    for (let i = 0; i < input.length; i += 1) {
      hash ^= input.charCodeAt(i);
      hash = Math.imul(hash, 16777619);
    }
    return hash >>> 0;
  }

  function checksumBytes(bytes) {
    let checksum = 0;
    for (let i = 0; i < bytes.length; i += 1) {
      checksum = (checksum + bytes[i] * ((i % 31) + 1)) >>> 0;
    }
    return checksum >>> 0;
  }

  function randomNonce(length = 12) {
    const bytes = new Uint8Array(length);
    crypto.getRandomValues(bytes);
    return bytes;
  }

  function buildKeystream(length, nonceHex) {
    const stream = new Uint8Array(length);
    let state = hashSeed(`bilm-backup::${nonceHex}::${location.origin}::${length}`) || 0x9e3779b9;
    for (let i = 0; i < length; i += 1) {
      state ^= state << 13;
      state ^= state >>> 17;
      state ^= state << 5;
      stream[i] = state & 0xff;
    }
    return stream;
  }

  function bytesToBase62(bytes) {
    if (!bytes.length) return '0';
    let value = 0n;
    for (let i = 0; i < bytes.length; i += 1) {
      value = (value << 8n) + BigInt(bytes[i]);
    }
    let encoded = '';
    while (value > 0n) {
      const rem = Number(value % 62n);
      encoded = BASE62_ALPHABET[rem] + encoded;
      value /= 62n;
    }
    let leadingZeroCount = 0;
    for (let i = 0; i < bytes.length && bytes[i] === 0; i += 1) {
      leadingZeroCount += 1;
    }
    return `${'0'.repeat(leadingZeroCount)}${encoded || '0'}`;
  }

  function base62ToBytes(encoded) {
    const cleaned = String(encoded || '').trim();
    if (!/^[0-9A-Za-z]+$/.test(cleaned)) {
      throw new Error('Backup code must only contain letters and numbers.');
    }
    const leadingZeroCount = cleaned.match(/^0+/)?.[0]?.length || 0;
    const meaningful = cleaned.slice(leadingZeroCount);
    let value = 0n;
    for (let i = 0; i < meaningful.length; i += 1) {
      const idx = BASE62_ALPHABET.indexOf(meaningful[i]);
      if (idx < 0) throw new Error('Backup code contains invalid characters.');
      value = (value * 62n) + BigInt(idx);
    }
    const bytes = [];
    while (value > 0n) {
      bytes.push(Number(value & 0xffn));
      value >>= 8n;
    }
    bytes.reverse();
    return new Uint8Array([...new Array(leadingZeroCount).fill(0), ...bytes]);
  }

  function encodeBackup(payload) {
    const encoder = new TextEncoder();
    const raw = encoder.encode(JSON.stringify(payload));
    const nonce = randomNonce();
    const nonceHex = Array.from(nonce).map(byte => byte.toString(16).padStart(2, '0')).join('');
    const keystream = buildKeystream(raw.length, nonceHex);
    const encrypted = raw.map((byte, index) => byte ^ keystream[index]);
    const packed = new Uint8Array(nonce.length + encrypted.length + 4);
    packed.set(nonce, 0);
    packed.set(encrypted, nonce.length);
    const check = checksumBytes(raw);
    packed[packed.length - 4] = (check >>> 24) & 0xff;
    packed[packed.length - 3] = (check >>> 16) & 0xff;
    packed[packed.length - 2] = (check >>> 8) & 0xff;
    packed[packed.length - 1] = check & 0xff;
    return `${BACKUP_FORMAT_PREFIX}${bytesToBase62(packed)}`;
  }

  function decodeBackup(code) {
    if (!String(code || '').startsWith(BACKUP_FORMAT_PREFIX)) {
      return JSON.parse(code);
    }
    const packed = base62ToBytes(String(code).slice(BACKUP_FORMAT_PREFIX.length));
    if (packed.length < 17) {
      throw new Error('Backup code is too short.');
    }
    const nonce = packed.slice(0, 12);
    const checksumOffset = packed.length - 4;
    const encrypted = packed.slice(12, checksumOffset);
    const expectedChecksum = ((packed[checksumOffset] << 24) | (packed[checksumOffset + 1] << 16) | (packed[checksumOffset + 2] << 8) | packed[checksumOffset + 3]) >>> 0;
    const nonceHex = Array.from(nonce).map(byte => byte.toString(16).padStart(2, '0')).join('');
    const keystream = buildKeystream(encrypted.length, nonceHex);
    const decrypted = encrypted.map((byte, index) => byte ^ keystream[index]);
    const actualChecksum = checksumBytes(decrypted);
    if (actualChecksum !== expectedChecksum) {
      throw new Error('Backup code failed verification.');
    }
    const decoder = new TextDecoder();
    return JSON.parse(decoder.decode(decrypted));
  }

  function openDataModal({ title, message, code = '', importMode = false }) {
    dataModalTitle.textContent = title;
    dataModalMessage.textContent = message;
    dataCodeField.value = code;
    dataCodeField.readOnly = !importMode;
    copyDataBtn.hidden = importMode;
    downloadDataBtn.hidden = importMode;
    pasteImportBtn.hidden = !importMode;
    uploadImportBtn.hidden = !importMode;
    applyImportBtn.hidden = !importMode;
    dataModal.classList.add('open');
  }

  function closeDataModal() {
    dataModal.classList.remove('open');
    pendingImportPayload = null;
  }

  function parseBackup(raw) {
    const payload = decodeBackup(raw);
    if (!payload || payload.schema !== 'bilm-backup-v1') {
      throw new Error('Invalid backup schema.');
    }
    return payload;
  }

  function applyBackup(payload) {
    localStorage.clear();
    sessionStorage.clear();

    Object.entries(payload.localStorage || {}).forEach(([key, value]) => {
      localStorage.setItem(key, value);
    });

    Object.entries(payload.sessionStorage || {}).forEach(([key, value]) => {
      sessionStorage.setItem(key, value);
    });

    document.cookie.split(';').forEach(cookie => {
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.slice(0, eqPos).trim() : cookie.trim();
      if (name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      }
    });

    const importedCookies = String(payload.cookies || '');
    importedCookies.split(';').map(entry => entry.trim()).filter(Boolean).forEach(cookieEntry => {
      document.cookie = `${cookieEntry};path=/`;
    });
  }

  function applySettings(partial) {
    const current = window.bilmTheme?.getSettings?.() || {};
    window.bilmTheme?.setSettings?.({ ...current, ...partial });
  }

  function syncUI() {
    const settings = window.bilmTheme?.getSettings?.() || {};
    const accentValue = settings.accent || '#a855f7';
    accentPicker.value = accentValue;
    if ([...accentPresetsSelect.options].some(option => option.value === accentValue)) {
      accentPresetsSelect.value = accentValue;
    }
    const backgroundValue = settings.background || 'deep';
    backgroundSelect.value = backgroundValue;
    customBackgroundPicker.value = settings.customBackground || '#0b0b14';
    motionToggle.checked = settings.motion !== false;
    particleToggle.checked = settings.particles !== false;
    incognitoToggle.checked = settings.incognito === true;
    const preferredServer = settings.defaultServer || 'vidsrc';
    serverSelect.value = supportedServers.includes(preferredServer) ? preferredServer : 'vidsrc';
  }


  function updateAutoSaveCountdownLabel() {
    const user = window.bilmAuth?.getCurrentUser?.();
    if (!user) {
      cloudStatus.textContent = 'Auto save paused until you log in.';
      return;
    }
    nextAutoSaveAt = getGlobalAutoSaveNextAt();
    const secondsLeft = Math.max(0, Math.ceil((nextAutoSaveAt - Date.now()) / 1000));
    cloudStatus.textContent = `Auto save in ${secondsLeft} seconds.`;
  }

  function stopAutoSaveTimer() {
    if (autoSaveIntervalId) {
      clearInterval(autoSaveIntervalId);
      autoSaveIntervalId = null;
    }
    if (autoSaveTickId) {
      clearInterval(autoSaveTickId);
      autoSaveTickId = null;
    }
    nextAutoSaveAt = 0;
    updateAutoSaveCountdownLabel();
  }

  async function runSaveNow(reason = 'manual') {
    await ensureAuthReady();
    const user = window.bilmAuth.getCurrentUser();
    if (!user) {
      openLoginModal();
      throw new Error('Please log in first.');
    }
    await window.bilmAuth.saveCloudSnapshot(collectBackupData());
    if (reason !== 'auto') cloudStatus.textContent = 'Save complete. Local data uploaded.';
  }

  function startAutoSaveTimer() {
    stopAutoSaveTimer();
    const settings = window.bilmTheme?.getSettings?.() || {};
    if (settings.accountTimedAutosave === false) {
      cloudStatus.textContent = 'Auto save disabled.';
      return;
    }
    if (!window.bilmAuth?.getCurrentUser?.()) {
      updateAutoSaveCountdownLabel();
      return;
    }

    nextAutoSaveAt = getGlobalAutoSaveNextAt();
    updateAutoSaveCountdownLabel();
    autoSaveTickId = setInterval(updateAutoSaveCountdownLabel, 1000);
    autoSaveIntervalId = setInterval(async () => {
      try {
        await runSaveNow('auto');
      } catch (error) {
        cloudStatus.textContent = `Auto save failed: ${error.message}`;
      } finally {
        nextAutoSaveAt = getGlobalAutoSaveNextAt();
        updateAutoSaveCountdownLabel();
      }
    }, 60000);
  }

  async function saveCredentialsForAutofill(email, password) {
    if (!('credentials' in navigator) || !window.PasswordCredential) return;
    try {
      const credential = new window.PasswordCredential({ id: email, password, name: email });
      await navigator.credentials.store(credential);
    } catch (error) {
      console.warn('Credential save skipped:', error);
    }
  }

  function setPasswordVisibility(inputEl, toggleBtn) {
    if (!inputEl || !toggleBtn) return;
    const visible = inputEl.type === 'text';
    inputEl.type = visible ? 'password' : 'text';
    toggleBtn.textContent = visible ? 'Show Password' : 'Hide Password';
    toggleBtn.classList.add('btn', 'btn-outline');
  }


  function openLoginModal() {
    loginStatus.textContent = '';
    loginModal.classList.add('open');
  }

  function closeLoginModal() {
    loginModal.classList.remove('open');
  }

  function openSignUpModal() {
    signUpStatus.textContent = '';
    signUpModal.classList.add('open');
  }

  function closeSignUpModal() {
    signUpModal.classList.remove('open');
  }

  function updateAccountUi(user) {
    if (user) {
      accountStatusText.textContent = `Logged in as ${user.email || 'account user'}.`;
      openSignInBtn.hidden = true;
      openSignUpBtn.hidden = true;
      logoutBtn.hidden = false;
      openAccountSettingsBtn.disabled = false;
      cloudStatus.textContent = 'Account ready. Open Account Settings to sync or merge data.';
      loginHelperText.textContent = 'Logged in successfully.';
      startAutoSaveTimer();
    } else {
      accountStatusText.textContent = 'You are in guest mode. Log in to enable account sync.';
      openSignInBtn.hidden = false;
      openSignUpBtn.hidden = false;
      logoutBtn.hidden = true;
      openAccountSettingsBtn.disabled = false;
      cloudStatus.textContent = 'Log in to use account sync features.';
      loginHelperText.textContent = 'Use email and password to log in.';
      stopAutoSaveTimer();
    }
  }

  async function ensureAuthReady() {
    const start = Date.now();
    while (!window.bilmAuth && Date.now() - start < 7000) {
      await new Promise((resolve) => setTimeout(resolve, 50));
    }
    if (!window.bilmAuth) throw new Error('Auth module did not load.');
    await window.bilmAuth.init();
  }

  async function clearAllLocalData() {
    localStorage.clear();
    sessionStorage.clear();

    document.cookie.split(';').forEach((cookie) => {
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.slice(0, eqPos).trim() : cookie.trim();
      if (name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      }
    });

    if (window.indexedDB?.databases) {
      const databases = await window.indexedDB.databases();
      await Promise.all((databases || []).map((db) => new Promise((resolve) => {
        if (!db.name) {
          resolve();
          return;
        }
        const request = window.indexedDB.deleteDatabase(db.name);
        request.onsuccess = () => resolve();
        request.onerror = () => resolve();
        request.onblocked = () => resolve();
      })));
    }

    if (window.caches?.keys) {
      const cacheKeys = await window.caches.keys();
      await Promise.all(cacheKeys.map((cacheKey) => window.caches.delete(cacheKey)));
    }
  }

  async function autoSyncAfterSignIn() {
    const localSnapshot = collectBackupData();
    const cloudSnapshot = await window.bilmAuth.getCloudSnapshot();

    if (!cloudSnapshot) {
      await window.bilmAuth.saveCloudSnapshot(localSnapshot);
      cloudStatus.textContent = 'New account detected. Local data was merged into your account.';
      return;
    }

    const merged = mergeSnapshots(localSnapshot, cloudSnapshot);
    applyBackup(merged);
    await window.bilmAuth.saveCloudSnapshot(merged);
    cloudStatus.textContent = 'Auto Sync complete. Reloading with your account data...';
    setTimeout(() => location.reload(), 300);
  }

  function mergeSnapshots(localSnapshot, cloudSnapshot) {
    const localData = localSnapshot || collectBackupData();
    const cloudData = cloudSnapshot || {};
    const cookieItems = [
      ...String(cloudData.cookies || '').split(';').map((item) => item.trim()).filter(Boolean),
      ...String(localData.cookies || '').split(';').map((item) => item.trim()).filter(Boolean)
    ];
    return {
      schema: 'bilm-backup-v1',
      exportedAt: new Date().toISOString(),
      origin: location.origin,
      pathname: location.pathname,
      localStorage: { ...(localData.localStorage || {}), ...(cloudData.localStorage || {}) },
      sessionStorage: { ...(localData.sessionStorage || {}), ...(cloudData.sessionStorage || {}) },
      cookies: [...new Set(cookieItems)].join('; ')
    };
  }

  async function syncLocalToCloud(reason = 'manual') {
    await runSaveNow(reason);
    nextAutoSaveAt = getGlobalAutoSaveNextAt();
    updateAutoSaveCountdownLabel();
  }

  async function mergeLocalAndCloud() {
    await ensureAuthReady();
    const user = window.bilmAuth.getCurrentUser();
    if (!user) {
      openLoginModal();
      throw new Error('Please log in first.');
    }
    const localSnapshot = collectBackupData();
    const cloudSnapshot = await window.bilmAuth.getCloudSnapshot();
    if (!cloudSnapshot) {
      cloudStatus.textContent = 'No cloud data yet. Uploading local data now.';
      await window.bilmAuth.saveCloudSnapshot(localSnapshot);
      cloudStatus.textContent = 'No cloud data existed, so local data was saved to your account.';
      return;
    }
    const merged = mergeSnapshots(localSnapshot, cloudSnapshot);
    applyBackup(merged);
    await window.bilmAuth.saveCloudSnapshot(merged);
    cloudStatus.textContent = 'Merge complete. Local + cloud data were combined and synced.';
    cloudStatus.textContent = 'Merge complete. Reloading...';
    setTimeout(() => location.reload(), 250);
  }

  accentPresets.forEach(({ value, label }) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    accentPresetsSelect.appendChild(option);
  });

  accentPresetsSelect.addEventListener('change', (event) => {
    const color = event.target.value;
    accentPicker.value = color;
    applySettings({ accent: color });
  });


  accentPicker.addEventListener('input', (event) => {
    applySettings({ accent: event.target.value });
    if ([...accentPresetsSelect.options].some(option => option.value === event.target.value)) {
      accentPresetsSelect.value = event.target.value;
    }
  });

  backgroundSelect.addEventListener('change', (event) => {
    applySettings({ background: event.target.value });
  });

  customBackgroundPicker.addEventListener('input', (event) => {
    applySettings({ customBackground: event.target.value, background: 'custom' });
    backgroundSelect.value = 'custom';
  });

  motionToggle.addEventListener('change', (event) => {
    applySettings({ motion: event.target.checked });
  });

  particleToggle.addEventListener('change', (event) => {
    applySettings({ particles: event.target.checked });
  });

  incognitoToggle.addEventListener('change', (event) => {
    applySettings({ incognito: event.target.checked });
  });

  serverSelect.addEventListener('change', (event) => {
    applySettings({ defaultServer: event.target.value });
  });

  resetThemeBtn.addEventListener('click', () => {
    if (!confirm('Reset theme to the default purple style?')) return;
    window.bilmTheme?.resetTheme?.();
    syncUI();
  });

  resetDataBtn.addEventListener('click', () => {
    const confirmReset = confirm('âš ï¸ This will erase all saved site data on your device. Continue?');
    if (!confirmReset) return;

    try {
      localStorage.clear();
      sessionStorage.clear();

      document.cookie.split(';').forEach(cookie => {
        const eqPos = cookie.indexOf('=');
        const name = eqPos > -1 ? cookie.slice(0, eqPos).trim() : cookie.trim();
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      });

      alert('âœ… Site data cleared. Reloading fresh.');
      location.reload();
    } catch (err) {
      console.error('Error clearing data:', err);
      alert('âŒ Something went wrong while clearing data.');
    }
  });

  exportDataBtn.addEventListener('click', () => {
    const code = encodeBackup(collectBackupData());
    openDataModal({
      title: 'Export Backup Code',
      message: 'Copy this secure backup code or download it as a coded file. Keep it private; it contains your site data.',
      code
    });
    backupStatus.textContent = `Export ready (${code.length.toLocaleString()} chars).`;
  });

  importDataBtn.addEventListener('click', () => {
    openDataModal({
      title: 'Import Backup Code',
      message: 'Paste a backup code or upload a save file, then apply import to replace your current local data.',
      importMode: true
    });
    backupStatus.textContent = 'Import popup opened.';
  });

  importFileInput.addEventListener('change', async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const raw = await file.text();
    dataCodeField.value = raw;
    backupStatus.textContent = `Loaded ${file.name}.`;
    importFileInput.value = '';
  });

  pasteImportBtn.addEventListener('click', async () => {
    try {
      const clipboardText = await navigator.clipboard.readText();
      dataCodeField.value = clipboardText;
      backupStatus.textContent = 'Backup code pasted from clipboard.';
    } catch (err) {
      backupStatus.textContent = 'Clipboard read blocked. Paste manually into the textbox.';
    }
  });

  uploadImportBtn.addEventListener('click', () => {
    importFileInput.click();
  });

  copyDataBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(dataCodeField.value);
      backupStatus.textContent = 'Backup code copied to clipboard.';
    } catch (err) {
      backupStatus.textContent = 'Clipboard blocked. Manually copy from the textbox.';
    }
  });

  downloadDataBtn.addEventListener('click', () => {
    const blob = new Blob([dataCodeField.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `bilm-backup-${new Date().toISOString().replace(/[:.]/g, '-')}.bilm`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    backupStatus.textContent = 'Backup code downloaded.';
  });

  applyImportBtn.addEventListener('click', () => {
    try {
      pendingImportPayload = parseBackup(dataCodeField.value);
      if (!confirm('Import this backup now? This will overwrite current local data.')) return;
      applyBackup(pendingImportPayload);
      backupStatus.textContent = 'Backup imported. Reloading...';
      setTimeout(() => location.reload(), 250);
    } catch (err) {
      console.error('Import failed:', err);
      backupStatus.textContent = `Import failed: ${err.message}`;
    }
  });


  openSignInBtn.addEventListener('click', () => {
    openLoginModal();
  });

  openSignUpBtn.addEventListener('click', () => {
    openSignUpModal();
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      if (!confirm('Log out of your account?')) return;
      await window.bilmAuth.signOut();
      stopAutoSaveTimer();
      await clearAllLocalData();
      cloudStatus.textContent = 'Logged out and cleared local data. Reloading...';
      setTimeout(() => location.reload(), 250);
    } catch (err) {
      cloudStatus.textContent = `Logout failed: ${err.message}`;
    }
  });

  openAccountSettingsBtn.addEventListener('click', () => {
    window.location.href = '../settings/account/';
  });

  loginForm.addEventListener('submit', (event) => {
    event.preventDefault();
    loginBtn.click();
  });

  signUpForm.addEventListener('submit', (event) => {
    event.preventDefault();
    signUpBtn.click();
  });

  loginBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      await window.bilmAuth.signIn(email, password);
      await saveCredentialsForAutofill(email, password);
      if ((window.bilmTheme?.getSettings?.() || {}).accountAutoSync !== false) {
        await autoSyncAfterSignIn();
      } else {
        cloudStatus.textContent = 'Logged in successfully.';
      }
      loginStatus.textContent = 'Logged in.';
      startAutoSaveTimer();
      closeLoginModal();
    } catch (err) {
      loginStatus.textContent = `Log in failed: ${err.message}`;
    }
  });

  signUpBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      const email = signUpEmail.value.trim();
      const password = signUpPassword.value;
      await window.bilmAuth.signUp(email, password);
      await saveCredentialsForAutofill(email, password);
      if ((window.bilmTheme?.getSettings?.() || {}).accountAutoSync !== false) {
        await autoSyncAfterSignIn();
      } else {
        cloudStatus.textContent = 'Account created. You can sync any time from Account Settings.';
      }
      signUpStatus.textContent = 'Account created.';
      startAutoSaveTimer();
      closeSignUpModal();
    } catch (err) {
      signUpStatus.textContent = `Sign up failed: ${err.message}`;
    }
  });

  openCreateAccountBtn.addEventListener('click', () => {
    closeLoginModal();
    openSignUpModal();
  });

  backToLoginBtn.addEventListener('click', () => {
    closeSignUpModal();
    openLoginModal();
  });

  toggleLoginPasswordBtn.addEventListener('click', () => setPasswordVisibility(loginPassword, toggleLoginPasswordBtn));
  toggleSignUpPasswordBtn.addEventListener('click', () => setPasswordVisibility(signUpPassword, toggleSignUpPasswordBtn));

  closeLoginModalBtn.addEventListener('click', closeLoginModal);
  closeSignUpModalBtn.addEventListener('click', closeSignUpModal);

  loginModal.addEventListener('click', (event) => {
    if (event.target === loginModal) closeLoginModal();
  });

  signUpModal.addEventListener('click', (event) => {
    if (event.target === signUpModal) closeSignUpModal();
  });



  async function initCloudAuthUi() {
    try {
      await ensureAuthReady();
      updateAccountUi(window.bilmAuth.getCurrentUser());
      window.bilmAuth.onAuthStateChanged((user) => {
        updateAccountUi(user);
      });
    } catch (err) {
      accountStatusText.textContent = 'Account tools are unavailable right now. Refresh and try again.';
      cloudStatus.textContent = `Auth setup failed: ${err.message}`;
      loginHelperText.textContent = 'If this keeps happening, disable blockers for Firebase and reload.';
      openAccountSettingsBtn.disabled = false;
    }
  }

  closeDataModalBtn.addEventListener('click', closeDataModal);
  dataModal.addEventListener('click', (event) => {
    if (event.target === dataModal) closeDataModal();
  });

  window.addEventListener('DOMContentLoaded', () => {
    syncUI();
    updateAutoSaveCountdownLabel();
    initCloudAuthUi();
  });
  window.addEventListener('bilm:theme-changed', syncUI);
</script>

</body>
</html>
