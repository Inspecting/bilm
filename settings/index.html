<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilm üíú - Settings</title>

  <!-- PWA + iOS fullscreen support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0a0a0a" />

  <!-- PWA Manifest and Icon -->
  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icon.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../shared/theme.css" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100vw;
      min-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
    }

    .settings-content {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 28px 22px 80px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 20px 0 26px;
    }

    .page-header h1 {
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      color: var(--text-primary);
    }

    .page-header p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .settings-card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .settings-card h2 {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .settings-card p {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: var(--surface-2);
      border: 1px solid transparent;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      flex-wrap: wrap;
    }

    .control-row:hover {
      border-color: var(--accent-soft);
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .control-row label {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .control-row > div {
      min-width: 180px;
      flex: 1 1 auto;
    }

    .control-row small {
      display: block;
      color: var(--text-subtle);
      font-size: 0.75rem;
    }

    select,
    input[type="color"],
    input[type="email"],
    input[type="password"] {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      font-family: inherit;
    }

    select:focus,
    input[type="color"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      flex: 0 0 auto;
      margin-left: auto;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle span {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      transition: background var(--transition-fast);
      cursor: pointer;
    }

    .toggle span::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--text-primary);
      transition: transform var(--transition-fast);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
    }

    .toggle input:checked + span {
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 78%, #ffffff 22%));
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .toggle input:checked + span::after {
      transform: translateX(20px);
    }

    .preset-control {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
      flex-wrap: nowrap;
      width: 100%;
      max-width: min(100%, 420px);
      margin-left: 0;
    }

    .inline-picker {
      width: clamp(40px, 10vw, 52px);
      height: 36px;
      padding: 3px;
      flex: 0 1 auto;
    }

    .preset-select {
      min-width: 0;
      flex: 1 1 0;
      max-width: 340px;
      border-color: color-mix(in srgb, var(--preview-color, var(--accent)) 55%, var(--border));
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--preview-color, var(--accent)) 24%, transparent);
    }

    .preset-select:focus {
      border-color: var(--preview-color, var(--accent));
      box-shadow: 0 0 10px color-mix(in srgb, var(--preview-color, var(--accent)) 32%, transparent);
    }

    .actions-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, var(--button-accent, var(--accent)), color-mix(in srgb, var(--button-accent, var(--accent)) 78%, #ffffff 22%));
      box-shadow: 0 10px 20px color-mix(in srgb, var(--button-accent, var(--accent)) 42%, transparent);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px color-mix(in srgb, var(--button-accent, var(--accent)) 58%, transparent);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
      box-shadow: none;
      text-decoration: none;
    }

    .btn-outline:hover {
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }

    .backup-tools {
      display: grid;
      gap: 10px;
      width: 100%;
    }

    .backup-status {
      font-size: 0.8rem;
      color: var(--text-subtle);
      min-height: 1.1em;
    }

    .data-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(5, 5, 15, 0.75);
      backdrop-filter: blur(8px);
    }

    .data-modal.open {
      display: flex;
    }

    .data-modal__panel {
      width: min(860px, 100%);
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    .data-modal__panel h3 {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .data-modal__panel p {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .data-code {
      width: 100%;
      min-height: 230px;
      resize: vertical;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text-primary);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 0.78rem;
      padding: 10px;
      line-height: 1.4;
    }

    @media (max-width: 720px) {
      .settings-content {
        padding: 20px 16px 80px;
      }

      .control-row {
        align-items: flex-start;
      }
    }
  </style>

  <script src="../shared/access.js"></script>
  <script src="../shared/theme.js"></script>
    </head>
<body>

<div id="navbarContainer"></div>

<main>
  <div class="settings-content">
  <div class="page-header">
    <h1>Settings</h1>
    <p>Personalize the Bilm experience with your preferred theme, motion, and playback defaults.</p>
  </div>

  <div class="settings-grid">
    <section class="settings-card">
      <h2>Theme & Accent</h2>
      <p>Fine tune your accent color and background mode.</p>

      <div class="control-row">
        <div>
          <label for="accentPresetsSelect">Accent Color</label>
          <small>Choose from presets or pick a custom color.</small>
        </div>
        <div class="preset-control">
          <input id="accentPicker" class="inline-picker" type="color" aria-label="Custom accent color" />
          <select id="accentPresetsSelect" class="preset-select" aria-label="Accent color presets"></select>
        </div>
      </div>


      <div class="control-row">
        <div>
          <label for="backgroundSelect">Background Mode</label>
          <small>Pick a preset mode or choose a custom color.</small>
        </div>
        <div class="preset-control">
          <input id="customBackgroundPicker" class="inline-picker" type="color" aria-label="Custom background color" />
          <select id="backgroundSelect" class="preset-select">
            <option value="deep">Deep</option>
            <option value="midnight">Midnight</option>
            <option value="velvet">Velvet</option>
            <option value="aurora">Aurora</option>
            <option value="slate">Slate</option>
            <option value="sunset">Sunset</option>
            <option value="custom">Custom</option>
          </select>
        </div>
      </div>
    </section>

    <section class="settings-card">
      <h2>Motion & Effects</h2>
      <p>Control animation and particle effects for performance and comfort.</p>

      <div class="control-row">
        <div>
          <label>Motion</label>
          <small>Reduce transitions and motion.</small>
        </div>
        <label class="toggle">
          <input id="motionToggle" type="checkbox" />
          <span></span>
        </label>
      </div>

      <div class="control-row">
        <div>
          <label>Particles</label>
          <small>Background particle shimmer on home.</small>
        </div>
        <label class="toggle">
          <input id="particleToggle" type="checkbox" />
          <span></span>
        </label>
      </div>

      <div class="control-row">
        <div>
          <label>Loading</label>
          <small>Show the loading page before opening Home.</small>
        </div>
        <label class="toggle">
          <input id="loadingToggle" type="checkbox" />
          <span></span>
        </label>
      </div>
    </section>


    <section class="settings-card">
      <h2>Account</h2>
      <div class="control-row">
        <div>
          <label>Account Status</label>
          <small id="accountStatusText">Checking account status...</small>
        </div>
        <div class="actions-row">
          <button class="btn" id="openSignInBtn">Log In</button>
          <button class="btn btn-outline" id="openSignUpBtn">Sign Up</button>
          <button class="btn btn-outline" id="logoutBtn" hidden>Log Out</button>
        </div>
      </div>

      <div class="control-row">
        <div>
          <label>Account Settings</label>
          <small>Open your account settings and profile options.</small>
        </div>
        <div class="actions-row">
          <button class="btn" id="openAccountSettingsBtn">Open Account Settings</button>
        </div>
      </div>

      <div class="control-row">
        <div>
          <label>Data Transfer</label>
          <small>Export/import local data or use cloud transfer while signed in.</small>
        </div>
        <div class="backup-tools">
          <div class="actions-row">
            <button class="btn" id="exportDataBtn">Export</button>
            <button class="btn btn-outline" id="importDataBtn">Import</button>
          </div>
          <input id="importFileInput" type="file" accept="application/json,.json,text/plain" hidden />
          <span class="backup-status" id="backupStatus" aria-live="polite">No transfer action yet.</span>
        </div>
      </div>

      <span class="backup-status" id="cloudStatus" aria-live="polite" hidden></span>
    </section>

    <section class="settings-card">
      <h2>Defaults</h2>
      <p>Choose defaults for your viewer pages.</p>

      <div class="control-row">
        <div>
          <label for="serverSelect">Default Server</label>
          <small>Used for movies and TV viewers.</small>
        </div>
        <select id="serverSelect">
          <option value="embedmaster">EmbedMaster</option>
          <option value="vidsrc">VidSrc</option>
          <option value="godrive">GoDrive Player</option>
          <option value="multiembed">MultiEmbed</option>
        </select>
      </div>

      <div class="control-row">
        <div>
          <label for="proxyProviderSelect">Proxy</label>
          <small>Provider used when proxied playback is enabled.</small>
        </div>
        <select id="proxyProviderSelect">
          <option value="none">None</option>
          <option value="ultraviolet">Ultraviolet</option>
          <option value="scramjet">Scramjet</option>
        </select>
      </div>

      <div class="control-row">
        <div>
          <label>Proxied Playback</label>
          <small>Only the player embed loads through the selected proxy.</small>
        </div>
        <label class="toggle">
          <input id="proxyEnabledToggle" type="checkbox" />
          <span></span>
        </label>
      </div>
    </section>

    <section class="settings-card">
      <h2>History & Privacy</h2>
      <p>Manage how Bilm saves search and watch history on this device.</p>

      <div class="control-row">
        <div>
          <label>View History</label>
          <small>Open your saved search and watch history.</small>
        </div>
        <a class="btn btn-outline" href="../settings/history">View History</a>
              </div>

      <div class="control-row">
        <div>
          <label>Incognito</label>
          <small>Temporarily pause search and watch history.</small>
        </div>
        <label class="toggle">
          <input id="incognitoToggle" type="checkbox" />
          <span></span>
        </label>
      </div>
    </section>



    <section class="settings-card">
      <h2>Reset & Maintenance</h2>
      <p>Restore defaults or clear all local data.</p>

      <div class="actions-row">
        <button class="btn btn-outline" id="resetThemeBtn">Reset Theme</button>
        <button class="btn btn-danger" id="resetDataBtn">Reset Data</button>
      </div>
    </section>
  </div>
  </div>
</main>


<div class="data-modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
  <div class="data-modal__panel">
    <h3 id="loginModalTitle">Log In</h3>
    <p>Use your email and password to log in.</p>
    <form id="loginForm" autocomplete="on">
      <div class="backup-tools">
        <input id="loginEmail" name="email" type="email" placeholder="Email" autocomplete="email" />
        <input id="loginPassword" name="password" type="password" placeholder="Password" autocomplete="current-password" />
        <button class="btn btn-outline" id="toggleLoginPasswordBtn" type="button">Show Password</button>
        <span class="backup-status" id="loginStatus" aria-live="polite"></span>
        <small id="loginHelperText">Don&apos;t have an account? Use Create an Account.</small>
      </div>
      <div class="actions-row">
        <button class="btn" id="loginBtn" type="button">Log In</button>
        <button class="btn btn-outline" id="openCreateAccountBtn" type="button">Create an Account</button>
        <button class="btn btn-outline" id="closeLoginModalBtn" type="button">Close</button>
      </div>
    </form>
  </div>
</div>

<div class="data-modal" id="signUpModal" role="dialog" aria-modal="true" aria-labelledby="signUpModalTitle">
  <div class="data-modal__panel">
    <h3 id="signUpModalTitle">Sign Up</h3>
    <p>Create an account with your email and password.</p>
    <form id="signUpForm" autocomplete="on">
      <div class="backup-tools">
        <input id="signUpEmail" name="email" type="email" placeholder="Email" autocomplete="email" />
        <input id="signUpPassword" name="password" type="password" placeholder="Password" autocomplete="new-password" />
        <button class="btn btn-outline" id="toggleSignUpPasswordBtn" type="button">Show Password</button>
        <span class="backup-status" id="signUpStatus" aria-live="polite"></span>
      </div>
      <div class="actions-row">
        <button class="btn" id="signUpBtn" type="button">Create Account</button>
        <button class="btn btn-outline" id="backToLoginBtn" type="button">Back to Log In</button>
        <button class="btn btn-outline" id="closeSignUpModalBtn" type="button">Close</button>
      </div>
    </form>
  </div>
</div>

<div class="data-modal" id="dataModal" role="dialog" aria-modal="true" aria-labelledby="dataModalTitle">
  <div class="data-modal__panel">
    <h3 id="dataModalTitle">Backup Data</h3>
    <p id="dataModalMessage">Copy or download this backup JSON data.</p>
    <textarea id="dataCodeField" class="data-code" spellcheck="false"></textarea>
    <div class="actions-row">
      <button class="btn" id="copyDataBtn">Copy Data</button>
      <button class="btn btn-outline" id="downloadDataBtn">Download JSON</button>
      <button class="btn" id="cloudExportBtn" hidden>‚òÅÔ∏è Export</button>
      <button class="btn" id="pasteImportBtn" hidden>Paste from Clipboard</button>
      <button class="btn btn-outline" id="uploadImportBtn" hidden>Upload Save File</button>
      <button class="btn btn-outline" id="cloudImportBtn" hidden>‚òÅÔ∏è Import</button>
      <button class="btn btn-outline" id="applyImportBtn" hidden>Apply Import</button>
      <button class="btn btn-outline" id="closeDataModalBtn">Close</button>
    </div>
  </div>
</div>

<script src="../shared/auth.js" defer></script>
<script src="../shared/navbar.js" defer></script>

<script>
  const accentPresets = [
    { value: '#a855f7', label: 'Purple' },
    { value: '#c084fc', label: 'Lilac' },
    { value: '#7c3aed', label: 'Violet' },
    { value: '#ec4899', label: 'Pink' },
    { value: '#38bdf8', label: 'Sky Blue' }
  ];
  const backgroundPresetColors = {
    deep: '#0b0b14',
    midnight: '#05050b',
    velvet: '#120818',
    aurora: '#062a2a',
    slate: '#111827',
    sunset: '#2a1326'
  };
  const accentPresetsSelect = document.getElementById('accentPresetsSelect');
  const accentPicker = document.getElementById('accentPicker');
  const backgroundSelect = document.getElementById('backgroundSelect');
  const customBackgroundPicker = document.getElementById('customBackgroundPicker');
  const motionToggle = document.getElementById('motionToggle');
  const particleToggle = document.getElementById('particleToggle');
  const loadingToggle = document.getElementById('loadingToggle');
  const incognitoToggle = document.getElementById('incognitoToggle');
  const serverSelect = document.getElementById('serverSelect');
  const proxyProviderSelect = document.getElementById('proxyProviderSelect');
  const proxyEnabledToggle = document.getElementById('proxyEnabledToggle');
  const resetThemeBtn = document.getElementById('resetThemeBtn');
  const resetDataBtn = document.getElementById('resetDataBtn');
  const exportDataBtn = document.getElementById('exportDataBtn');
  const importDataBtn = document.getElementById('importDataBtn');
  const cloudExportBtn = document.getElementById('cloudExportBtn');
  const cloudImportBtn = document.getElementById('cloudImportBtn');
  const CLEAR_ON_LOGOUT_KEY = 'bilm-clear-local-on-logout';
  const importFileInput = document.getElementById('importFileInput');
  const backupStatus = document.getElementById('backupStatus');
  const dataModal = document.getElementById('dataModal');
  const dataModalTitle = document.getElementById('dataModalTitle');
  const dataModalMessage = document.getElementById('dataModalMessage');
  const dataCodeField = document.getElementById('dataCodeField');
  const copyDataBtn = document.getElementById('copyDataBtn');
  const downloadDataBtn = document.getElementById('downloadDataBtn');
  const pasteImportBtn = document.getElementById('pasteImportBtn');
  const uploadImportBtn = document.getElementById('uploadImportBtn');
  const applyImportBtn = document.getElementById('applyImportBtn');
  const closeDataModalBtn = document.getElementById('closeDataModalBtn');
  const accountStatusText = document.getElementById('accountStatusText');
  const openSignInBtn = document.getElementById('openSignInBtn');
  const openSignUpBtn = document.getElementById('openSignUpBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const openAccountSettingsBtn = document.getElementById('openAccountSettingsBtn');
  const cloudStatus = document.getElementById('cloudStatus');
  const syncToggle = document.getElementById('syncToggle');
  const syncStatusText = document.getElementById('syncStatusText');
  const loginModal = document.getElementById('loginModal');
  const loginForm = document.getElementById('loginForm');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginStatus = document.getElementById('loginStatus');
  const loginHelperText = document.getElementById('loginHelperText');
  const loginBtn = document.getElementById('loginBtn');
  const toggleLoginPasswordBtn = document.getElementById('toggleLoginPasswordBtn');
  const openCreateAccountBtn = document.getElementById('openCreateAccountBtn');
  const closeLoginModalBtn = document.getElementById('closeLoginModalBtn');
  const signUpModal = document.getElementById('signUpModal');
  const signUpForm = document.getElementById('signUpForm');
  const signUpEmail = document.getElementById('signUpEmail');
  const signUpPassword = document.getElementById('signUpPassword');
  const signUpStatus = document.getElementById('signUpStatus');
  const signUpBtn = document.getElementById('signUpBtn');
  const toggleSignUpPasswordBtn = document.getElementById('toggleSignUpPasswordBtn');
  const backToLoginBtn = document.getElementById('backToLoginBtn');
  const closeSignUpModalBtn = document.getElementById('closeSignUpModalBtn');
  const supportedServers = ['embedmaster', 'vidsrc', 'godrive', 'multiembed'];
  const supportedProxyProviders = ['none', 'ultraviolet', 'scramjet'];
  const SYNC_ENABLED_KEY = 'bilm-sync-enabled';
  const BACKUP_LOCAL_ALLOWLIST = [/^bilm-/, /^tmdb-/, /^theme-/];
  const BACKUP_SESSION_ALLOWLIST = [/^bilm-/, /^tmdb-/];
  let pendingImportPayload = null;
  let syncDebounceTimer = null;
  let applyingRemoteSync = false;
  let lastCloudAppliedAt = 0;
  let lastUploadedSignature = '';

  function shouldIncludeStorageKey(key, allowlist) {
    return allowlist.some((pattern) => pattern.test(String(key || '')));
  }

  function readStorage(storage, allowlist = []) {
    return Object.entries(storage).reduce((all, [key, value]) => {
      if (allowlist.length && !shouldIncludeStorageKey(key, allowlist)) return all;
      all[key] = value;
      return all;
    }, {});
  }

  function collectBackupData() {
    const localState = readStorage(localStorage, BACKUP_LOCAL_ALLOWLIST);
    delete localState[SYNC_ENABLED_KEY];
    return {
      schema: 'bilm-backup-v1',
      exportedAt: new Date().toISOString(),
      origin: location.origin,
      pathname: location.pathname,
      localStorage: localState,
      sessionStorage: readStorage(sessionStorage, BACKUP_SESSION_ALLOWLIST)
    };
  }

  function formatBackup(payload) {
    return JSON.stringify(payload, null, 2);
  }

  function openDataModal({ title, message, code = '', importMode = false }) {
    if (!dataModal || !dataModalTitle || !dataModalMessage || !dataCodeField || !copyDataBtn || !downloadDataBtn || !pasteImportBtn || !uploadImportBtn || !applyImportBtn || !cloudExportBtn || !cloudImportBtn) return;
    dataModalTitle.textContent = title;
    dataModalMessage.textContent = message;
    dataCodeField.value = code;
    dataCodeField.readOnly = !importMode;
    copyDataBtn.hidden = importMode;
    downloadDataBtn.hidden = importMode;
    cloudExportBtn.hidden = importMode;
    pasteImportBtn.hidden = !importMode;
    uploadImportBtn.hidden = !importMode;
    cloudImportBtn.hidden = !importMode;
    applyImportBtn.hidden = !importMode;
    dataModal.classList.add('open');
  }

  function closeDataModal() {
    if (!dataModal) return;
    dataModal.classList.remove('open');
    pendingImportPayload = null;
  }


  function sanitizeImportText(raw) {
    return String(raw || '')
      .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, '')
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      .replace(/\r\n?/g, '\n')
      .trim();
  }

  function tryParseJsonCandidate(candidate) {
    try {
      return JSON.parse(candidate);
    } catch {
      return null;
    }
  }

  function salvageBackupInput(raw) {
    const sanitized = sanitizeImportText(raw);
    if (!sanitized) throw new Error('Backup data is empty.');

    const directPayload = tryParseJsonCandidate(sanitized);
    if (directPayload) return directPayload;

    const jsonMatch = sanitized.match(/\{[\s\S]*\}/);
    if (jsonMatch?.[0]) {
      const extracted = tryParseJsonCandidate(jsonMatch[0]);
      if (extracted) return extracted;
    }

    throw new Error('Backup data must be valid JSON.');
  }

  function parseBackup(raw) {
    const payload = salvageBackupInput(raw);
    if (!payload || payload.schema !== 'bilm-backup-v1') {
      throw new Error('Invalid backup schema.');
    }
    return payload;
  }

  function applyBackup(payload) {
    const syncPreference = localStorage.getItem(SYNC_ENABLED_KEY);
    localStorage.clear();
    sessionStorage.clear();

    Object.entries(payload.localStorage || {}).forEach(([key, value]) => {
      localStorage.setItem(key, value);
    });

    Object.entries(payload.sessionStorage || {}).forEach(([key, value]) => {
      sessionStorage.setItem(key, value);
    });

    if (syncPreference === '0') {
      localStorage.setItem(SYNC_ENABLED_KEY, '0');
    }
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
  }

  function applySettings(partial) {
    const current = window.bilmTheme?.getSettings?.() || {};
    window.bilmTheme?.setSettings?.({ ...current, ...partial });
  }

  function updatePresetVisuals() {
    accentPresetsSelect.style.setProperty('--preview-color', accentPicker.value || '#a855f7');
    const selectedBackground = backgroundSelect.value;
    const previewBackgroundColor = selectedBackground === 'custom'
      ? (customBackgroundPicker.value || '#0b0b14')
      : (backgroundPresetColors[selectedBackground] || '#0b0b14');
    backgroundSelect.style.setProperty('--preview-color', previewBackgroundColor);
  }

  function findBackgroundPresetByColor(color) {
    const normalized = (color || '').trim().toLowerCase();
    return Object.entries(backgroundPresetColors).find(([, value]) => value.toLowerCase() === normalized)?.[0] || null;
  }

  function syncUI() {
    const settings = window.bilmTheme?.getSettings?.() || {};
    const accentValue = settings.accent || '#a855f7';
    accentPicker.value = accentValue;
    if ([...accentPresetsSelect.options].some(option => option.value === accentValue)) {
      accentPresetsSelect.value = accentValue;
    } else {
      accentPresetsSelect.value = 'custom';
    }
    const customBackgroundValue = settings.customBackground || '#0b0b14';
    const backgroundValue = settings.background || 'deep';
    const matchingPreset = findBackgroundPresetByColor(customBackgroundValue);
    if (backgroundValue === 'custom' && matchingPreset) {
      backgroundSelect.value = matchingPreset;
      customBackgroundPicker.value = backgroundPresetColors[matchingPreset];
    } else {
      backgroundSelect.value = backgroundValue;
      customBackgroundPicker.value = backgroundValue === 'custom'
        ? customBackgroundValue
        : (backgroundPresetColors[backgroundValue] || customBackgroundValue);
    }
    motionToggle.checked = settings.motion !== false;
    particleToggle.checked = settings.particles !== false;
    loadingToggle.checked = settings.loading !== false;
    incognitoToggle.checked = settings.incognito === true;
    const preferredServer = settings.defaultServer || 'embedmaster';
    serverSelect.value = supportedServers.includes(preferredServer) ? preferredServer : 'embedmaster';
    const proxyProvider = settings.proxyProvider || 'none';
    proxyProviderSelect.value = supportedProxyProviders.includes(proxyProvider) ? proxyProvider : 'none';
    proxyEnabledToggle.checked = settings.proxyEnabled === true;
    updatePresetVisuals();
  }


  function isSyncEnabled() {
    return localStorage.getItem(SYNC_ENABLED_KEY) !== '0';
  }

  function setSyncEnabled(enabled) {
    localStorage.setItem(SYNC_ENABLED_KEY, enabled ? '1' : '0');
    if (syncToggle) syncToggle.checked = enabled;
    if (syncStatusText) {
      syncStatusText.textContent = enabled
        ? 'Live sync is on for this device.'
        : 'Live sync is paused on this device.';
    }
  }

  function snapshotSignature(snapshot) {
    try {
      return JSON.stringify(snapshot || null);
    } catch {
      return '';
    }
  }

  function scheduleAutoSync(reason = 'auto') {
    if (!isSyncEnabled()) return;
    clearTimeout(syncDebounceTimer);
    syncDebounceTimer = setTimeout(async () => {
      if (applyingRemoteSync || !isSyncEnabled()) return;
      try {
        await runSaveNow('auto');
      } catch (error) {
        console.warn(`Auto sync skipped (${reason}):`, error);
      }
    }, 700);
  }

  async function runSaveNow(reason = 'manual') {
    await ensureAuthReady();
    const user = window.bilmAuth.getCurrentUser();
    if (!user) {
      if (reason === 'manual') {
        const allowLogin = confirm('Cloud export requires sign in. Open log in now?');
        if (allowLogin) openLoginModal();
        throw new Error('Please log in first.');
      }
      return false;
    }
    const snapshot = collectBackupData();
    await window.bilmAuth.saveCloudSnapshot(snapshot);
    lastUploadedSignature = snapshotSignature(snapshot);
    if (reason !== 'auto') cloudStatus.textContent = 'Save complete. Local data uploaded.';
    return true;
  }

  async function saveCredentialsForAutofill(email, password) {
    if (!('credentials' in navigator) || !window.PasswordCredential) return;
    try {
      const credential = new window.PasswordCredential({ id: email, password, name: email });
      await navigator.credentials.store(credential);
    } catch (error) {
      console.warn('Credential save skipped:', error);
    }
  }

  function setPasswordVisibility(inputEl, toggleBtn) {
    if (!inputEl || !toggleBtn) return;
    const visible = inputEl.type === 'text';
    inputEl.type = visible ? 'password' : 'text';
    toggleBtn.textContent = visible ? 'Show Password' : 'Hide Password';
    toggleBtn.classList.add('btn', 'btn-outline');
  }


  function openLoginModal() {
    loginStatus.textContent = '';
    loginModal.classList.add('open');
  }

  function closeLoginModal() {
    loginModal.classList.remove('open');
  }

  function openSignUpModal() {
    signUpStatus.textContent = '';
    signUpModal.classList.add('open');
  }

  function closeSignUpModal() {
    signUpModal.classList.remove('open');
  }

  function updateAccountUi(user) {
    if (user) {
      accountStatusText.textContent = `Logged in as ${user.email || 'account user'}.`;
      openSignInBtn.hidden = true;
      openSignUpBtn.hidden = true;
      logoutBtn.hidden = false;
      openAccountSettingsBtn.disabled = false;
      cloudStatus.textContent = isSyncEnabled()
        ? 'Account ready. Live sync is active on this device.'
        : 'Account ready. Live sync is paused on this device.';
      loginHelperText.textContent = 'Logged in successfully.';
    } else {
      accountStatusText.textContent = 'You are in guest mode. Log in to use account transfer tools.';
      openSignInBtn.hidden = false;
      openSignUpBtn.hidden = false;
      logoutBtn.hidden = true;
      openAccountSettingsBtn.disabled = false;
      cloudStatus.textContent = 'Log in to use account features.';
      loginHelperText.textContent = 'Use email and password to log in.';
    }
  }

  async function ensureAuthReady() {
    const start = Date.now();
    while (!window.bilmAuth && Date.now() - start < 7000) {
      await new Promise((resolve) => setTimeout(resolve, 50));
    }
    if (!window.bilmAuth) throw new Error('Auth module did not load.');
    await window.bilmAuth.init();
  }

  async function clearAllLocalData() {
    localStorage.clear();
    sessionStorage.clear();

    document.cookie.split(';').forEach((cookie) => {
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.slice(0, eqPos).trim() : cookie.trim();
      if (name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      }
    });

    if (window.indexedDB?.databases) {
      const databases = await window.indexedDB.databases();
      await Promise.all((databases || []).map((db) => new Promise((resolve) => {
        if (!db.name) {
          resolve();
          return;
        }
        const request = window.indexedDB.deleteDatabase(db.name);
        request.onsuccess = () => resolve();
        request.onerror = () => resolve();
        request.onblocked = () => resolve();
      })));
    }

    if (window.caches?.keys) {
      const cacheKeys = await window.caches.keys();
      await Promise.all(cacheKeys.map((cacheKey) => window.caches.delete(cacheKey)));
    }
  }

  accentPresets.forEach(({ value, label }) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    accentPresetsSelect.appendChild(option);
  });
  const customAccentOption = document.createElement('option');
  customAccentOption.value = 'custom';
  customAccentOption.textContent = 'Custom';
  accentPresetsSelect.appendChild(customAccentOption);

  accentPresetsSelect.addEventListener('change', (event) => {
    const color = event.target.value;
    if (color === 'custom') {
      applySettings({ accent: accentPicker.value });
      return;
    }
    accentPicker.value = color;
    applySettings({ accent: color });
    updatePresetVisuals();
  });


  accentPicker.addEventListener('input', (event) => {
    const color = event.target.value;
    applySettings({ accent: color });
    if ([...accentPresetsSelect.options].some(option => option.value === color)) {
      accentPresetsSelect.value = color;
    } else {
      accentPresetsSelect.value = 'custom';
    }
    updatePresetVisuals();
  });

  backgroundSelect.addEventListener('change', (event) => {
    const mode = event.target.value;
    if (mode !== 'custom') {
      customBackgroundPicker.value = backgroundPresetColors[mode] || '#0b0b14';
    }
    applySettings({ background: mode });
    updatePresetVisuals();
  });

  customBackgroundPicker.addEventListener('input', (event) => {
    const color = event.target.value;
    const matchingPreset = findBackgroundPresetByColor(color);
    if (matchingPreset) {
      backgroundSelect.value = matchingPreset;
      applySettings({ customBackground: color, background: matchingPreset });
    } else {
      backgroundSelect.value = 'custom';
      applySettings({ customBackground: color, background: 'custom' });
    }
    updatePresetVisuals();
  });

  motionToggle.addEventListener('change', (event) => {
    applySettings({ motion: event.target.checked });
  });

  particleToggle.addEventListener('change', (event) => {
    applySettings({ particles: event.target.checked });
  });

  loadingToggle.addEventListener('change', (event) => {
    applySettings({ loading: event.target.checked });
  });

  incognitoToggle.addEventListener('change', (event) => {
    applySettings({ incognito: event.target.checked });
  });

  serverSelect.addEventListener('change', (event) => {
    applySettings({ defaultServer: event.target.value });
  });

  proxyProviderSelect.addEventListener('change', (event) => {
    applySettings({ proxyProvider: event.target.value });
  });

  proxyEnabledToggle.addEventListener('change', (event) => {
    applySettings({ proxyEnabled: event.target.checked });
  });

  resetThemeBtn.addEventListener('click', () => {
    if (!confirm('Reset theme to the default purple style?')) return;
    window.bilmTheme?.resetTheme?.();
    syncUI();
  });

  resetDataBtn.addEventListener('click', () => {
    const confirmReset = confirm('‚ö†Ô∏è This will erase all saved site data on your device. Continue?');
    if (!confirmReset) return;

    const typedConfirmation = prompt('Type RESET to confirm data wipe.');
    if (typedConfirmation?.trim().toUpperCase() !== 'RESET') {
      alert('Reset canceled. Confirmation text did not match.');
      return;
    }

    try {
      localStorage.clear();
      sessionStorage.clear();

      document.cookie.split(';').forEach(cookie => {
        const eqPos = cookie.indexOf('=');
        const name = eqPos > -1 ? cookie.slice(0, eqPos).trim() : cookie.trim();
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      });

      alert('‚úÖ Site data cleared. Reloading fresh.');
      location.reload();
    } catch (err) {
      console.error('Error clearing data:', err);
      alert('‚ùå Something went wrong while clearing data.');
    }
  });

  exportDataBtn?.addEventListener('click', () => {
    const backupJson = formatBackup(collectBackupData());
    openDataModal({
      title: 'Export Backup Data',
      message: 'Copy this JSON backup data or download it as a file. It contains your site data as plain text.',
      code: backupJson
    });
    backupStatus.textContent = `Export ready (${backupJson.length.toLocaleString()} chars).`;
  });

  importDataBtn?.addEventListener('click', () => {
    openDataModal({
      title: 'Import Backup Data',
      message: 'Paste backup JSON or upload a JSON save file. Import auto-salvages spacing and extra wrapper text.',
      importMode: true
    });
    backupStatus.textContent = 'Import popup opened.';
  });

  importFileInput?.addEventListener('change', async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const raw = await file.text();
    dataCodeField.value = raw;
    backupStatus.textContent = `Loaded ${file.name}. We'll auto-salvage spacing and extra text on import.`;
    importFileInput.value = '';
  });

  pasteImportBtn?.addEventListener('click', async () => {
    try {
      const clipboardText = await navigator.clipboard.readText();
      dataCodeField.value = clipboardText;
      backupStatus.textContent = 'Backup JSON pasted from clipboard.';
    } catch (err) {
      backupStatus.textContent = 'Clipboard read blocked. Paste manually into the textbox.';
    }
  });

  uploadImportBtn?.addEventListener('click', () => {
    importFileInput.click();
  });

  copyDataBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(dataCodeField.value);
      backupStatus.textContent = 'Backup JSON copied to clipboard.';
    } catch (err) {
      backupStatus.textContent = 'Clipboard blocked. Manually copy from the textbox.';
    }
  });

  downloadDataBtn?.addEventListener('click', () => {
    const blob = new Blob([dataCodeField.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `bilm-backup-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    backupStatus.textContent = 'Backup data downloaded.';
  });

  applyImportBtn?.addEventListener('click', () => {
    try {
      pendingImportPayload = parseBackup(dataCodeField.value);
      if (!confirm('Import this backup now? This will overwrite current local data.')) return;
      applyBackup(pendingImportPayload);
      backupStatus.textContent = 'Backup imported. Reloading...';
      setTimeout(() => location.reload(), 250);
    } catch (err) {
      console.error('Import failed:', err);
      backupStatus.textContent = `Import failed: ${err.message}`;
    }
  });

  cloudExportBtn?.addEventListener('click', async () => {
    try {
      await runSaveNow('manual');
      backupStatus.textContent = 'Export successful.';
      alert('Export successful.');
      backupStatus.textContent = 'Cloud export successful. Your latest local data is now saved to your account.';
    } catch (err) {
      backupStatus.textContent = `Cloud export failed: ${err.message}`;
    }
  });

  cloudImportBtn?.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      const user = window.bilmAuth?.getCurrentUser?.();
      if (!user) {
        const allowLogin = confirm('Cloud import requires sign in. Open log in now?');
        if (allowLogin) openLoginModal();
        throw new Error('Please log in first.');
      }
      const snapshot = await window.bilmAuth.getCloudSnapshot();
      if (!snapshot) throw new Error('No cloud backup found for this account.');
      dataCodeField.value = formatBackup(snapshot);
      backupStatus.textContent = 'Cloud backup loaded. Review the JSON data, then click Apply Import when ready.';
    } catch (err) {
      backupStatus.textContent = `Cloud import failed: ${err.message}`;
    }
  });


  openSignInBtn.addEventListener('click', () => {
    openLoginModal();
  });

  openSignUpBtn.addEventListener('click', () => {
    openSignUpModal();
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      if (!confirm('Log out of your account?')) return;
      if (confirm('Do you want to export your data before logging out?')) {
        const backupJson = formatBackup(collectBackupData());
        openDataModal({
          title: 'Export Backup Data',
          message: 'Copy this backup JSON data before signing out.',
          code: backupJson
        });
        cloudStatus.textContent = 'Export opened. Log out again after saving your backup.';
        return;
      }
      await window.bilmAuth.signOut();
      const clearOnLogout = localStorage.getItem(CLEAR_ON_LOGOUT_KEY) !== '0';
      if (clearOnLogout) {
        await clearAllLocalData();
      }
      cloudStatus.textContent = clearOnLogout
        ? 'Logged out and cleared local data. Reloading...'
        : 'Logged out without clearing local data. Reloading...';
      setTimeout(() => location.reload(), 250);
    } catch (err) {
      cloudStatus.textContent = `Logout failed: ${err.message}`;
    }
  });

  openAccountSettingsBtn.addEventListener('click', () => {
    window.location.href = '../settings/account/';
  });

  loginForm.addEventListener('submit', (event) => {
    event.preventDefault();
    loginBtn.click();
  });

  signUpForm.addEventListener('submit', (event) => {
    event.preventDefault();
    signUpBtn.click();
  });

  loginBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      if (!isValidEmail(email)) throw new Error('Enter a valid email address.');
      if (!password) throw new Error('Enter your password.');
      await window.bilmAuth.signIn(email, password);
      await saveCredentialsForAutofill(email, password);
      cloudStatus.textContent = 'Logged in successfully.';
      loginStatus.textContent = 'Logged in.';
      closeLoginModal();
    } catch (err) {
      loginStatus.textContent = `Log in failed: ${err.message}`;
    }
  });

  signUpBtn.addEventListener('click', async () => {
    try {
      await ensureAuthReady();
      const email = signUpEmail.value.trim();
      const password = signUpPassword.value;
      if (!isValidEmail(email)) throw new Error('Enter a valid email address.');
      if (!password || password.length < 8) throw new Error('Password must be at least 8 characters.');
      await window.bilmAuth.signUp(email, password);
      await saveCredentialsForAutofill(email, password);
      cloudStatus.textContent = 'Account created successfully.';
      signUpStatus.textContent = 'Account created.';
      closeSignUpModal();
    } catch (err) {
      signUpStatus.textContent = `Sign up failed: ${err.message}`;
    }
  });

  openCreateAccountBtn.addEventListener('click', () => {
    closeLoginModal();
    openSignUpModal();
  });

  backToLoginBtn.addEventListener('click', () => {
    closeSignUpModal();
    openLoginModal();
  });

  toggleLoginPasswordBtn.addEventListener('click', () => setPasswordVisibility(loginPassword, toggleLoginPasswordBtn));
  toggleSignUpPasswordBtn.addEventListener('click', () => setPasswordVisibility(signUpPassword, toggleSignUpPasswordBtn));

  closeLoginModalBtn.addEventListener('click', closeLoginModal);
  closeSignUpModalBtn.addEventListener('click', closeSignUpModal);

  loginModal.addEventListener('click', (event) => {
    if (event.target === loginModal) closeLoginModal();
  });

  signUpModal.addEventListener('click', (event) => {
    if (event.target === signUpModal) closeSignUpModal();
  });



  async function initCloudAuthUi() {
    try {
      await ensureAuthReady();
      setSyncEnabled(isSyncEnabled());
      updateAccountUi(window.bilmAuth.getCurrentUser());
      window.bilmAuth.onAuthStateChanged((user) => {
        updateAccountUi(user);
        if (user && isSyncEnabled()) scheduleAutoSync('auth-state');
      });
      window.bilmAuth.onCloudSnapshotChanged?.((event) => {
        if (!isSyncEnabled() || !event?.snapshot || event?.hasPendingWrites) return;
        const remoteUpdatedAtMs = Number(event.updatedAtMs || event.snapshot?.meta?.updatedAtMs || 0);
        if (remoteUpdatedAtMs && remoteUpdatedAtMs <= lastCloudAppliedAt) return;
        lastCloudAppliedAt = remoteUpdatedAtMs || Date.now();
        lastUploadedSignature = snapshotSignature(event.snapshot);
        cloudStatus.textContent = 'Cloud update detected. Sync engine will apply only if newer than local data.';
      });
    } catch (err) {
      accountStatusText.textContent = 'Account tools are unavailable right now. Refresh and try again.';
      cloudStatus.textContent = `Auth setup failed: ${err.message}`;
      loginHelperText.textContent = 'If this keeps happening, disable blockers for Firebase and reload.';
      openAccountSettingsBtn.disabled = false;
    }
  }

  closeDataModalBtn?.addEventListener('click', closeDataModal);
  dataModal?.addEventListener('click', (event) => {
    if (event.target === dataModal) closeDataModal();
  });

  syncToggle?.addEventListener('change', (event) => {
    const enabled = event.target.checked;
    setSyncEnabled(enabled);
    if (enabled) {
      cloudStatus.textContent = 'Live sync enabled for this device.';
      scheduleAutoSync('toggle-on');
    } else {
      cloudStatus.textContent = 'Live sync paused on this device.';
    }
    updateAccountUi(window.bilmAuth?.getCurrentUser?.() || null);
  });

  window.addEventListener('DOMContentLoaded', () => {
    syncUI();
    setSyncEnabled(isSyncEnabled());
    initCloudAuthUi();
  });
  window.addEventListener('bilm:theme-changed', () => {
    syncUI();
    scheduleAutoSync('theme-change');
  });
  window.addEventListener('beforeunload', () => {
    if (!isSyncEnabled() || applyingRemoteSync) return;
    try {
      const user = window.bilmAuth?.getCurrentUser?.();
      if (user) window.bilmAuth.saveCloudSnapshot(collectBackupData());
    } catch {
      // no-op best effort
    }
  });
</script>

</body>
</html>
